-----------Tablas------------
CREATE TABLE taxonomy (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,

    kingdom VARCHAR(100) NOT NULL,
    phylum VARCHAR(100) NULL,
    class_name VARCHAR(100) NULL,
    order_name VARCHAR(100) NULL,
    family VARCHAR(100) NULL,
    genus VARCHAR(100) NULL,

    PRIMARY KEY (id),

    UNIQUE KEY uq_taxonomy_full (
        kingdom, phylum, class_name, order_name, family, genus
    )
) ENGINE=InnoDB;

CREATE TABLE species (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,

    scientific_name VARCHAR(255) NOT NULL,
    common_name VARCHAR(255) NULL,

    iucn_status ENUM(
        'EX',  -- Extinct
        'EW',  -- Extinct in the Wild
        'CR',  -- Critically Endangered
        'EN',  -- Endangered
        'VU',  -- Vulnerable
        'NT',  -- Near Threatened
        'LC',  -- Least Concern
        'DD',  -- Data Deficient
        'NE'   -- Not Evaluated
    ) NOT NULL,

    taxonomy_id INT UNSIGNED NOT NULL,

    description TEXT NULL,
    habitat TEXT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
        ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (id),

    UNIQUE KEY uq_species_scientific_name (scientific_name),
    INDEX idx_species_status (iucn_status),
    INDEX idx_species_taxonomy (taxonomy_id),

    CONSTRAINT fk_species_taxonomy
        FOREIGN KEY (taxonomy_id)
        REFERENCES taxonomy(id)
        ON DELETE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE region (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,

    name VARCHAR(150) NOT NULL,

    type ENUM(
        'continent',
        'subregion',
        'biome',
        'climate',
        'ecoregion'
    ) NOT NULL,

    parent_id INT UNSIGNED NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id),

    UNIQUE KEY uq_region_name_type (name, type),
    INDEX idx_region_type (type),
    INDEX idx_region_parent (parent_id),

    CONSTRAINT fk_region_parent
        FOREIGN KEY (parent_id)
        REFERENCES region(id)
        ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE species_region (
    species_id INT UNSIGNED NOT NULL,
    region_id INT UNSIGNED NOT NULL,

    PRIMARY KEY (species_id, region_id),

    INDEX idx_sr_region (region_id),

    CONSTRAINT fk_sr_species
        FOREIGN KEY (species_id)
        REFERENCES species(id)
        ON DELETE CASCADE,

    CONSTRAINT fk_sr_region
        FOREIGN KEY (region_id)
        REFERENCES region(id)
        ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE species_media (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,

    species_id INT UNSIGNED NOT NULL,

    media_url VARCHAR(500) NOT NULL,
    media_type ENUM('image','video','document')
        NOT NULL DEFAULT 'image',

    credit VARCHAR(255) NULL,
    license VARCHAR(150) NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id),
    INDEX idx_media_species (species_id),

    CONSTRAINT fk_media_species
        FOREIGN KEY (species_id)
        REFERENCES species(id)
        ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE data_source (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,

    name VARCHAR(150) NOT NULL,
    url VARCHAR(500) NULL,
    type ENUM(
        'iucn',
        'wikipedia',
        'government',
        'ngo',
        'research',
        'database',
        'other'
    ) NOT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id),
    UNIQUE KEY uq_data_source_name (name)
) ENGINE=InnoDB;

CREATE TABLE population_census (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,

    species_id INT UNSIGNED NOT NULL,
    census_date DATE NOT NULL,
    population BIGINT NOT NULL,

    source_id INT UNSIGNED NOT NULL,
    notes TEXT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id),

    UNIQUE KEY uq_species_date (species_id, census_date),
    INDEX idx_pc_species_date (species_id, census_date),
    INDEX idx_pc_source (source_id),

    CONSTRAINT fk_pc_species
        FOREIGN KEY (species_id)
        REFERENCES species(id)
        ON DELETE CASCADE,

    CONSTRAINT fk_pc_source
        FOREIGN KEY (source_id)
        REFERENCES data_source(id)
        ON DELETE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE status_history (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,

    species_id INT UNSIGNED NOT NULL,

    old_status ENUM(
        'EX', 'EW', 'CR', 'EN', 'VU', 'NT', 'LC', 'DD', 'NE'
    ) NOT NULL,

    new_status ENUM(
        'EX', 'EW', 'CR', 'EN', 'VU', 'NT', 'LC', 'DD', 'NE'
    ) NOT NULL,

    changed_at DATE NOT NULL,

    source_id INT UNSIGNED NOT NULL,

    PRIMARY KEY (id),

    INDEX idx_sh_species (species_id),
    INDEX idx_sh_new_status (new_status),
    INDEX idx_sh_source (source_id),

    CONSTRAINT fk_sh_species
        FOREIGN KEY (species_id)
        REFERENCES species(id)
        ON DELETE CASCADE,

    CONSTRAINT fk_sh_source
        FOREIGN KEY (source_id)
        REFERENCES data_source(id)
        ON DELETE RESTRICT
) ENGINE=InnoDB;

----------indices------------
CREATE INDEX idx_species_status_tax
ON species (iucn_status, taxonomy_id);

CREATE INDEX idx_sh_species_date
ON status_history (species_id, changed_at);

CREATE INDEX idx_pc_species_date_desc
ON population_census (species_id, census_date);

--------Triger Status History-------
CREATE TRIGGER trg_species_status_change
BEFORE UPDATE ON species
FOR EACH ROW
BEGIN
    IF NOT (OLD.iucn_status <=> NEW.iucn_status) THEN
        INSERT INTO status_history (
            species_id,
            old_status,
            new_status,
            changed_at,
            source_id
        )
        VALUES (
            OLD.id,
            OLD.iucn_status,
            NEW.iucn_status,
            NOW(),
            NULL
        );
    END IF;
END;

---------vista diccionario----------
CREATE OR REPLACE VIEW vw_data_dictionary AS
SELECT 
    c.TABLE_NAME,
    c.ORDINAL_POSITION,
    c.COLUMN_NAME,
    c.COLUMN_TYPE,
    c.IS_NULLABLE,
    c.COLUMN_DEFAULT,
    c.EXTRA,

    CASE
        WHEN tc.CONSTRAINT_TYPE = 'PRIMARY KEY' THEN 'PRIMARY KEY'
        WHEN tc.CONSTRAINT_TYPE = 'UNIQUE' THEN 'UNIQUE'
        WHEN tc.CONSTRAINT_TYPE = 'FOREIGN KEY' THEN 'FOREIGN KEY'
        ELSE ''
    END AS constraint_type,

    kcu.CONSTRAINT_NAME,
    kcu.REFERENCED_TABLE_NAME,
    kcu.REFERENCED_COLUMN_NAME,
    rc.UPDATE_RULE,
    rc.DELETE_RULE,

    s.INDEX_NAME,
    s.NON_UNIQUE,
    s.SEQ_IN_INDEX,
    s.INDEX_TYPE

FROM INFORMATION_SCHEMA.COLUMNS c

LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu
    ON c.TABLE_SCHEMA = kcu.TABLE_SCHEMA
    AND c.TABLE_NAME = kcu.TABLE_NAME
    AND c.COLUMN_NAME = kcu.COLUMN_NAME

LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
    ON kcu.CONSTRAINT_NAME = tc.CONSTRAINT_NAME
    AND kcu.TABLE_SCHEMA = tc.TABLE_SCHEMA
    AND kcu.TABLE_NAME = tc.TABLE_NAME

LEFT JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc
    ON kcu.CONSTRAINT_NAME = rc.CONSTRAINT_NAME
    AND kcu.CONSTRAINT_SCHEMA = rc.CONSTRAINT_SCHEMA

LEFT JOIN INFORMATION_SCHEMA.STATISTICS s
    ON c.TABLE_SCHEMA = s.TABLE_SCHEMA
    AND c.TABLE_NAME = s.TABLE_NAME
    AND c.COLUMN_NAME = s.COLUMN_NAME

WHERE c.TABLE_SCHEMA = DATABASE();